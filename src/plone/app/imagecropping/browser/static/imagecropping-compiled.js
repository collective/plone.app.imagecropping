!function(t){"function"==typeof define&&define.amd?define("plone_app_imagecropping_cropper",["jquery"],t):"object"==typeof exports?t(require("jquery")):t(jQuery)}(function(k){"use strict";var s=k(window),a=k(document),n=window.location,t=window.navigator,o=window.ArrayBuffer,h=window.Uint8Array,c=window.DataView,r=window.btoa,p="cropper",l="cropper-modal",d="cropper-hide",x="cropper-hidden",g="cropper-move",u="cropper-crop",i="cropper-disabled",f="mousedown touchstart pointerdown MSPointerDown",m="mousemove touchmove pointermove MSPointerMove",v="mouseup touchend touchcancel pointerup pointercancel MSPointerUp MSPointerCancel",w="wheel mousewheel DOMMouseScroll",b="dblclick",_="load."+p,C="error."+p,$="resize."+p,y="build."+p,B="built."+p,D="cropstart."+p,T="cropmove."+p,L="cropend."+p,X="crop."+p,Y="zoom."+p,M=/e|w|s|n|se|sw|ne|nw|all|crop|move|zoom/,R=/^data\:/,W=/^data\:([^\;]+)\;base64,/,z=/^data\:image\/jpeg.*;base64,/,E="preview",H="action",O="se",P="sw",F="ne",I="nw",U="all",S="crop",j="move",A="zoom",N=k.isFunction(k("<canvas>")[0].getContext),q=t&&/safari/i.test(t.userAgent)&&/apple computer/i.test(t.vendor),V=Number,K=Math.min,Z=Math.max,Q=Math.abs,G=Math.sin,J=Math.cos,tt=Math.sqrt,it=Math.round,et=Math.floor,st=String.fromCharCode;function at(t){return"number"==typeof t&&!isNaN(t)}function ot(t){return void 0===t}function nt(t,i){var e=[];return at(i)&&e.push(i),e.slice.apply(t,e)}function ht(t,i){var e=nt(arguments,2);return function(){return t.apply(i,e.concat(nt(arguments)))}}function rt(t){return t?' crossOrigin="'+t+'"':""}function pt(t){var i=[],e=t.rotate,s=t.scaleX,t=t.scaleY;return at(e)&&i.push("rotate("+e+"deg)"),at(s)&&at(t)&&i.push("scale("+s+","+t+")"),i.length?i.join(" "):"none"}function lt(t,i){var e,s=Q(t.degree)%180,a=(90<s?180-s:s)*Math.PI/180,o=G(a),n=J(a),s=t.width,a=t.height,t=t.aspectRatio,n=i?(e=s/(n+o/t))/t:(e=s*n+a*o,s*o+a*n);return{width:e,height:n}}function ct(t){var i,e,s,a,o,n,h,r,p=new c(t),l=p.byteLength;if(255===p.getUint8(0)&&216===p.getUint8(1))for(h=2;h<l;){if(255===p.getUint8(h)&&225===p.getUint8(h+1)){o=h;break}h++}if(o&&(e=o+10,"Exif"===function(t,i,e){var s="",a=i;for(e+=i;a<e;a++)s+=st(t.getUint8(a));return s}(p,o+4,4)&&((a=18761===(t=p.getUint16(e)))||19789===t)&&42===p.getUint16(e+2,a)&&8<=(s=p.getUint32(e+4,a))&&(n=e+s)),n)for(l=p.getUint16(n,a),r=0;r<l;r++)if(h=n+12*r+2,274===p.getUint16(h,a)){h+=8,i=p.getUint16(h,a),q&&p.setUint16(h,1,a);break}return i}function dt(t,i){this.$element=k(t),this.options=k.extend({},dt.DEFAULTS,k.isPlainObject(i)&&i),this.isLoaded=!1,this.isBuilt=!1,this.isCompleted=!1,this.isRotated=!1,this.isCropped=!1,this.isDisabled=!1,this.isReplaced=!1,this.isLimited=!1,this.wheeling=!1,this.isImg=!1,this.originalUrl="",this.canvas=null,this.cropBox=null,this.init()}dt.prototype={constructor:dt,init:function(){var t,i=this.$element;if(i.is("img")){if(this.isImg=!0,this.originalUrl=t=i.attr("src"),!t)return;t=i.prop("src")}else i.is("canvas")&&N&&(t=i[0].toDataURL());this.load(t)},trigger:function(t,i){i=k.Event(t,i);return this.$element.trigger(i),i},load:function(t){var i,e=this.options,s=this.$element;if(t&&(s.one(y,e.build),!this.trigger(y).isDefaultPrevented()))return this.url=t,this.image={},e.checkOrientation&&o?(i=k.proxy(this.read,this),R.test(t)?z.test(t)?i(function(t){for(var t=t.replace(W,""),i=atob(t),e=i.length,t=new o(e),s=new h(t),a=0;a<e;a++)s[a]=i.charCodeAt(a);return t}(t)):this.clone():((e=new XMLHttpRequest).onerror=e.onabort=k.proxy(function(){this.clone()},this),e.onload=function(){i(this.response)},e.open("get",t),e.responseType="arraybuffer",void e.send())):this.clone()},read:function(t){var i,e,s,a=this.options,o=ct(t),n=this.image;if(1<o)switch(this.url=function(t){for(var i=new h(t),e=i.length,s="",a=0;a<e;a++)s+=st(i[a]);return"data:image/jpeg;base64,"+r(s)}(t),o){case 2:e=-1;break;case 3:i=-180;break;case 4:s=-1;break;case 5:i=90,s=-1;break;case 6:i=90;break;case 7:i=90,e=-1;break;case 8:i=-90}a.rotatable&&(n.rotate=i),a.scalable&&(n.scaleX=e,n.scaleY=s),this.clone()},clone:function(){var t,i,e=this.options,s=this.$element,a=this.url,o="";e.checkCrossOrigin&&((i=(i=a).match(/^(https?:)\/\/([^\:\/\?#]+):?(\d*)/i))&&(i[1]!==n.protocol||i[2]!==n.hostname||i[3]!==n.port))&&(t=(o=s.prop("crossOrigin"))?a:(o="anonymous",i=a,t="timestamp="+(new Date).getTime(),i+(-1===i.indexOf("?")?"?":"&")+t)),this.crossOrigin=o,this.crossOriginUrl=t,this.$clone=a=k("<img"+rt(o)+' src="'+(t||a)+'">'),this.isImg?s[0].complete?this.start():s.one(_,k.proxy(this.start,this)):a.one(_,k.proxy(this.start,this)).one(C,k.proxy(this.stop,this)).addClass(d).insertAfter(s)},start:function(){var t,i=this.$element,e=this.$clone;this.isImg||(e.off(C,this.stop),i=e),e=i[0],t=k.proxy(function(t,i){k.extend(this.image,{naturalWidth:t,naturalHeight:i,aspectRatio:t/i}),this.isLoaded=!0,this.build()},this),e.naturalWidth&&!q?t(e.naturalWidth,e.naturalHeight):((i=document.createElement("img")).onload=function(){t(this.width,this.height)},i.src=e.src)},stop:function(){this.$clone.remove(),this.$clone=null},build:function(){var t,i,e,s=this.options,a=this.$element,o=this.$clone;this.isLoaded&&(this.isBuilt&&this.unbuild(),this.$container=a.parent(),this.$cropper=t=k(dt.TEMPLATE),this.$canvas=t.find(".cropper-canvas").append(o),this.$dragBox=t.find(".cropper-drag-box"),this.$cropBox=i=t.find(".cropper-crop-box"),this.$viewBox=t.find(".cropper-view-box"),this.$face=e=i.find(".cropper-face"),a.addClass(x).after(t),this.isImg||o.removeClass(d),this.initPreview(),this.bind(),s.aspectRatio=Z(0,s.aspectRatio)||NaN,s.viewMode=Z(0,K(3,it(s.viewMode)))||0,s.autoCrop?(this.isCropped=!0,s.modal&&this.$dragBox.addClass(l)):i.addClass(x),s.guides||i.find(".cropper-dashed").addClass(x),s.center||i.find(".cropper-center").addClass(x),s.cropBoxMovable&&e.addClass(g).data(H,U),s.highlight||e.addClass("cropper-invisible"),s.background&&t.addClass("cropper-bg"),s.cropBoxResizable||i.find(".cropper-line, .cropper-point").addClass(x),this.setDragMode(s.dragMode),this.render(),this.isBuilt=!0,this.setData(s.data),a.one(B,s.built),setTimeout(k.proxy(function(){this.trigger(B),this.isCompleted=!0},this),0))},unbuild:function(){this.isBuilt&&(this.isBuilt=!1,this.isCompleted=!1,this.initialImage=null,this.initialCanvas=null,this.initialCropBox=null,this.container=null,this.canvas=null,this.cropBox=null,this.unbind(),this.resetPreview(),this.$preview=null,this.$viewBox=null,this.$cropBox=null,this.$dragBox=null,this.$canvas=null,this.$container=null,this.$cropper.remove(),this.$cropper=null)},render:function(){this.initContainer(),this.initCanvas(),this.initCropBox(),this.renderCanvas(),this.isCropped&&this.renderCropBox()},initContainer:function(){var t=this.options,i=this.$element,e=this.$container,s=this.$cropper;s.addClass(x),i.removeClass(x),s.css(this.container={width:Z(e.width(),V(t.minContainerWidth)||200),height:Z(e.height(),V(t.minContainerHeight)||100)}),i.addClass(x),s.removeClass(x)},initCanvas:function(){var t=this.options.viewMode,i=this.container,e=i.width,s=i.height,a=this.image,o=a.naturalWidth,n=a.naturalHeight,h=90===Q(a.rotate),r=h?n:o,i=h?o:n,h=r/i,o=e,n=s;e<s*h?3===t?o=s*h:n=e/h:3===t?n=e/h:o=s*h,(h={naturalWidth:r,naturalHeight:i,aspectRatio:h,width:o,height:n}).oldLeft=h.left=(e-o)/2,h.oldTop=h.top=(s-n)/2,this.canvas=h,this.isLimited=1===t||2===t,this.limitCanvas(!0,!0),this.initialImage=k.extend({},a),this.initialCanvas=k.extend({},h)},limitCanvas:function(t,i){var e,s=this.options,a=s.viewMode,o=this.container,n=o.width,h=o.height,r=this.canvas,p=r.aspectRatio,l=this.cropBox,o=this.isCropped&&l;t&&(t=V(s.minCanvasWidth)||0,e=V(s.minCanvasHeight)||0,a&&(1<a?(t=Z(t,n),e=Z(e,h),3===a&&(t<e*p?t=e*p:e=t/p)):t?t=Z(t,o?l.width:0):e?e=Z(e,o?l.height:0):o&&((t=l.width)<(e=l.height)*p?t=e*p:e=t/p)),t&&e?t<e*p?e=t/p:t=e*p:t?e=t/p:e&&(t=e*p),r.minWidth=t,r.minHeight=e,r.maxWidth=1/0,r.maxHeight=1/0),i&&(a?(e=n-r.width,i=h-r.height,r.minLeft=K(0,e),r.minTop=K(0,i),r.maxLeft=Z(0,e),r.maxTop=Z(0,i),o&&this.isLimited&&(r.minLeft=K(l.left,l.left+l.width-r.width),r.minTop=K(l.top,l.top+l.height-r.height),r.maxLeft=l.left,r.maxTop=l.top,2===a&&(r.width>=n&&(r.minLeft=K(0,e),r.maxLeft=Z(0,e)),r.height>=h&&(r.minTop=K(0,i),r.maxTop=Z(0,i))))):(r.minLeft=-r.width,r.minTop=-r.height,r.maxLeft=n,r.maxTop=h))},renderCanvas:function(t){var i,e=this.canvas,s=this.image,a=s.rotate,o=s.naturalWidth,n=s.naturalHeight;this.isRotated&&(this.isRotated=!1,(s=(i=lt({width:s.width,height:s.height,degree:a})).width/i.height)!==e.aspectRatio&&(e.left-=(i.width-e.width)/2,e.top-=(i.height-e.height)/2,e.width=i.width,e.height=i.height,e.aspectRatio=s,e.naturalWidth=o,e.naturalHeight=n,a%180&&(i=lt({width:o,height:n,degree:a}),e.naturalWidth=i.width,e.naturalHeight=i.height),this.limitCanvas(!0,!1))),(e.width>e.maxWidth||e.width<e.minWidth)&&(e.left=e.oldLeft),(e.height>e.maxHeight||e.height<e.minHeight)&&(e.top=e.oldTop),e.width=K(Z(e.width,e.minWidth),e.maxWidth),e.height=K(Z(e.height,e.minHeight),e.maxHeight),this.limitCanvas(!1,!0),e.oldLeft=e.left=K(Z(e.left,e.minLeft),e.maxLeft),e.oldTop=e.top=K(Z(e.top,e.minTop),e.maxTop),this.$canvas.css({width:e.width,height:e.height,left:e.left,top:e.top}),this.renderImage(),this.isCropped&&this.isLimited&&this.limitCropBox(!0,!0),t&&this.output()},renderImage:function(t){var i,e=this.canvas,s=this.image;s.rotate&&(i=lt({width:e.width,height:e.height,degree:s.rotate,aspectRatio:s.aspectRatio},!0)),k.extend(s,i?{width:i.width,height:i.height,left:(e.width-i.width)/2,top:(e.height-i.height)/2}:{width:e.width,height:e.height,left:0,top:0}),this.$clone.css({width:s.width,height:s.height,marginLeft:s.left,marginTop:s.top,transform:pt(s)}),t&&this.output()},initCropBox:function(){var t=this.options,i=this.canvas,e=t.aspectRatio,s=V(t.autoCropArea)||.8,t={width:i.width,height:i.height};e&&(i.height*e>i.width?t.height=t.width/e:t.width=t.height*e),this.cropBox=t,this.limitCropBox(!0,!0),t.width=K(Z(t.width,t.minWidth),t.maxWidth),t.height=K(Z(t.height,t.minHeight),t.maxHeight),t.width=Z(t.minWidth,t.width*s),t.height=Z(t.minHeight,t.height*s),t.oldLeft=t.left=i.left+(i.width-t.width)/2,t.oldTop=t.top=i.top+(i.height-t.height)/2,this.initialCropBox=k.extend({},t)},limitCropBox:function(t,i){var e,s=this.options,a=s.aspectRatio,o=this.container,n=o.width,h=o.height,r=this.canvas,p=this.cropBox,l=this.isLimited;t&&(e=V(s.minCropBoxWidth)||0,o=V(s.minCropBoxHeight)||0,e=K(e,n),o=K(o,h),t=K(n,l?r.width:n),s=K(h,l?r.height:h),a&&(e&&o?e<o*a?o=e/a:e=o*a:e?o=e/a:o&&(e=o*a),t<s*a?s=t/a:t=s*a),p.minWidth=K(e,t),p.minHeight=K(o,s),p.maxWidth=t,p.maxHeight=s),i&&(l?(p.minLeft=Z(0,r.left),p.minTop=Z(0,r.top),p.maxLeft=K(n,r.left+r.width)-p.width,p.maxTop=K(h,r.top+r.height)-p.height):(p.minLeft=0,p.minTop=0,p.maxLeft=n-p.width,p.maxTop=h-p.height))},renderCropBox:function(){var t=this.options,i=this.container,e=i.width,s=i.height,i=this.cropBox;(i.width>i.maxWidth||i.width<i.minWidth)&&(i.left=i.oldLeft),(i.height>i.maxHeight||i.height<i.minHeight)&&(i.top=i.oldTop),i.width=K(Z(i.width,i.minWidth),i.maxWidth),i.height=K(Z(i.height,i.minHeight),i.maxHeight),this.limitCropBox(!1,!0),i.oldLeft=i.left=K(Z(i.left,i.minLeft),i.maxLeft),i.oldTop=i.top=K(Z(i.top,i.minTop),i.maxTop),t.movable&&t.cropBoxMovable&&this.$face.data(H,i.width===e&&i.height===s?j:U),this.$cropBox.css({width:i.width,height:i.height,left:i.left,top:i.top}),this.isCropped&&this.isLimited&&this.limitCanvas(!0,!0),this.isDisabled||this.output()},output:function(){this.preview(),this.isCompleted?this.trigger(X,this.getData()):this.isBuilt||this.$element.one(B,k.proxy(function(){this.trigger(X,this.getData())},this))},initPreview:function(){var t,i=rt(this.crossOrigin),e=i?this.crossOriginUrl:this.url;this.$preview=k(this.options.preview),this.$clone2=t=k("<img"+i+' src="'+e+'">'),this.$viewBox.html(t),this.$preview.each(function(){var t=k(this);t.data(E,{width:t.width(),height:t.height(),html:t.html()}),t.html("<img"+i+' src="'+e+'" style="display:block;width:100%;height:auto;min-width:0!important;min-height:0!important;max-width:none!important;max-height:none!important;image-orientation:0deg!important;">')})},resetPreview:function(){this.$preview.each(function(){var t=k(this),i=t.data(E);t.css({width:i.width,height:i.height}).html(i.html).removeData(E)})},preview:function(){var n=this.image,t=this.canvas,i=this.cropBox,h=i.width,r=i.height,p=n.width,l=n.height,c=i.left-t.left-n.left,d=i.top-t.top-n.top;this.isCropped&&!this.isDisabled&&(this.$clone2.css({width:p,height:l,marginLeft:-c,marginTop:-d,transform:pt(n)}),this.$preview.each(function(){var t=k(this),i=t.data(E),e=i.width,s=i.height,a=e,o=s,i=1;h&&(o=r*(i=e/h)),r&&s<o&&(a=h*(i=s/r),o=s),t.css({width:a,height:o}).find("img").css({width:p*i,height:l*i,marginLeft:-c*i,marginTop:-d*i,transform:pt(n)})}))},bind:function(){var t=this.options,i=this.$element,e=this.$cropper;k.isFunction(t.cropstart)&&i.on(D,t.cropstart),k.isFunction(t.cropmove)&&i.on(T,t.cropmove),k.isFunction(t.cropend)&&i.on(L,t.cropend),k.isFunction(t.crop)&&i.on(X,t.crop),k.isFunction(t.zoom)&&i.on(Y,t.zoom),e.on(f,k.proxy(this.cropStart,this)),t.zoomable&&t.zoomOnWheel&&e.on(w,k.proxy(this.wheel,this)),t.toggleDragModeOnDblclick&&e.on(b,k.proxy(this.dblclick,this)),a.on(m,this._cropMove=ht(this.cropMove,this)).on(v,this._cropEnd=ht(this.cropEnd,this)),t.responsive&&s.on($,this._resize=ht(this.resize,this))},unbind:function(){var t=this.options,i=this.$element,e=this.$cropper;k.isFunction(t.cropstart)&&i.off(D,t.cropstart),k.isFunction(t.cropmove)&&i.off(T,t.cropmove),k.isFunction(t.cropend)&&i.off(L,t.cropend),k.isFunction(t.crop)&&i.off(X,t.crop),k.isFunction(t.zoom)&&i.off(Y,t.zoom),e.off(f,this.cropStart),t.zoomable&&t.zoomOnWheel&&e.off(w,this.wheel),t.toggleDragModeOnDblclick&&e.off(b,this.dblclick),a.off(m,this._cropMove).off(v,this._cropEnd),t.responsive&&s.off($,this._resize)},resize:function(){var e,s,a,t=this.options.restore,i=this.$container,o=this.container;!this.isDisabled&&o&&(1==(a=i.width()/o.width)&&i.height()===o.height||(t&&(e=this.getCanvasData(),s=this.getCropBoxData()),this.render(),t&&(this.setCanvasData(k.each(e,function(t,i){e[t]=i*a})),this.setCropBoxData(k.each(s,function(t,i){s[t]=i*a})))))},dblclick:function(){this.isDisabled||(this.$dragBox.hasClass(u)?this.setDragMode(j):this.setDragMode(S))},wheel:function(t){var i=t.originalEvent||t,e=V(this.options.wheelZoomRatio)||.1,s=1;this.isDisabled||(t.preventDefault(),this.wheeling||(this.wheeling=!0,setTimeout(k.proxy(function(){this.wheeling=!1},this),50),i.deltaY?s=0<i.deltaY?1:-1:i.wheelDelta?s=-i.wheelDelta/120:i.detail&&(s=0<i.detail?1:-1),this.zoom(-s*e,t)))},cropStart:function(t){var i,e,s=this.options,a=t.originalEvent,o=a&&a.touches,n=t;if(!this.isDisabled){if(o){if(1<(i=o.length)){if(!s.zoomable||!s.zoomOnTouch||2!==i)return;n=o[1],this.startX2=n.pageX,this.startY2=n.pageY,e=A}n=o[0]}e=e||k(n.target).data(H),M.test(e)&&(this.trigger(D,{originalEvent:a,action:e}).isDefaultPrevented()||(t.preventDefault(),this.action=e,this.cropping=!1,this.startX=n.pageX||a&&a.pageX,this.startY=n.pageY||a&&a.pageY,e===S&&(this.cropping=!0,this.$dragBox.addClass(l))))}},cropMove:function(t){var i,e=this.options,s=t.originalEvent,a=s&&s.touches,o=t,n=this.action;if(!this.isDisabled){if(a){if(1<(i=a.length)){if(!e.zoomable||!e.zoomOnTouch||2!==i)return;o=a[1],this.endX2=o.pageX,this.endY2=o.pageY}o=a[0]}n&&(this.trigger(T,{originalEvent:s,action:n}).isDefaultPrevented()||(t.preventDefault(),this.endX=o.pageX||s&&s.pageX,this.endY=o.pageY||s&&s.pageY,this.change(o.shiftKey,n===A?t:null)))}},cropEnd:function(t){var i=t.originalEvent,e=this.action;this.isDisabled||e&&(t.preventDefault(),this.cropping&&(this.cropping=!1,this.$dragBox.toggleClass(l,this.isCropped&&this.options.modal)),this.action="",this.trigger(L,{originalEvent:i,action:e}))},change:function(t,i){var e,s,a=this.options.aspectRatio,o=this.action,n=this.container,h=this.canvas,r=this.cropBox,p=r.width,l=r.height,c=r.left,d=r.top,g=c+p,u=d+l,f=0,m=0,v=n.width,w=n.height,b=!0;switch(!a&&t&&(a=p&&l?p/l:1),this.limited&&(f=r.minLeft,m=r.minTop,v=f+K(n.width,h.left+h.width),w=m+K(n.height,h.top+h.height)),s={x:this.endX-this.startX,y:this.endY-this.startY},a&&(s.X=s.y*a,s.Y=s.x/a),o){case U:c+=s.x,d+=s.y;break;case"e":if(0<=s.x&&(v<=g||a&&(d<=m||w<=u))){b=!1;break}p+=s.x,a&&(l=p/a,d-=s.Y/2),p<0&&(o="w",p=0);break;case"n":if(s.y<=0&&(d<=m||a&&(c<=f||v<=g))){b=!1;break}l-=s.y,d+=s.y,a&&(p=l*a,c+=s.X/2),l<0&&(o="s",l=0);break;case"w":if(s.x<=0&&(c<=f||a&&(d<=m||w<=u))){b=!1;break}p-=s.x,c+=s.x,a&&(l=p/a,d+=s.Y/2),p<0&&(o="e",p=0);break;case"s":if(0<=s.y&&(w<=u||a&&(c<=f||v<=g))){b=!1;break}l+=s.y,a&&(p=l*a,c-=s.X/2),l<0&&(o="n",l=0);break;case F:if(a){if(s.y<=0&&(d<=m||v<=g)){b=!1;break}l-=s.y,d+=s.y,p=l*a}else!(0<=s.x)||g<v?p+=s.x:s.y<=0&&d<=m&&(b=!1),s.y<=0&&!(m<d)||(l-=s.y,d+=s.y);p<0&&l<0?(o=P,p=l=0):p<0?(o=I,p=0):l<0&&(o=O,l=0);break;case I:if(a){if(s.y<=0&&(d<=m||c<=f)){b=!1;break}l-=s.y,d+=s.y,p=l*a,c+=s.X}else!(s.x<=0)||f<c?(p-=s.x,c+=s.x):s.y<=0&&d<=m&&(b=!1),s.y<=0&&!(m<d)||(l-=s.y,d+=s.y);p<0&&l<0?(o=O,p=l=0):p<0?(o=F,p=0):l<0&&(o=P,l=0);break;case P:if(a){if(s.x<=0&&(c<=f||w<=u)){b=!1;break}p-=s.x,c+=s.x,l=p/a}else!(s.x<=0)||f<c?(p-=s.x,c+=s.x):0<=s.y&&w<=u&&(b=!1),0<=s.y&&!(u<w)||(l+=s.y);p<0&&l<0?(o=F,p=l=0):p<0?(o=O,p=0):l<0&&(o=I,l=0);break;case O:if(a){if(0<=s.x&&(v<=g||w<=u)){b=!1;break}l=(p+=s.x)/a}else!(0<=s.x)||g<v?p+=s.x:0<=s.y&&w<=u&&(b=!1),0<=s.y&&!(u<w)||(l+=s.y);p<0&&l<0?(o=I,p=l=0):p<0?(o=P,p=0):l<0&&(o=F,l=0);break;case j:this.move(s.x,s.y),b=!1;break;case A:this.zoom(function(t,i,e,s){i=tt(t*t+i*i);return(tt(e*e+s*s)-i)/i}(Q(this.startX-this.startX2),Q(this.startY-this.startY2),Q(this.endX-this.endX2),Q(this.endY-this.endY2)),i),this.startX2=this.endX2,this.startY2=this.endY2,b=!1;break;case S:if(!s.x||!s.y){b=!1;break}e=this.$cropper.offset(),c=this.startX-e.left,d=this.startY-e.top,p=r.minWidth,l=r.minHeight,0<s.x?o=0<s.y?O:F:s.x<0&&(c-=p,o=0<s.y?P:I),s.y<0&&(d-=l),this.isCropped||(this.$cropBox.removeClass(x),this.isCropped=!0,this.limited&&this.limitCropBox(!0,!0))}b&&(r.width=p,r.height=l,r.left=c,r.top=d,this.action=o,this.renderCropBox()),this.startX=this.endX,this.startY=this.endY},crop:function(){this.isBuilt&&!this.isDisabled&&(this.isCropped||(this.isCropped=!0,this.limitCropBox(!0,!0),this.options.modal&&this.$dragBox.addClass(l),this.$cropBox.removeClass(x)),this.setCropBoxData(this.initialCropBox))},reset:function(){this.isBuilt&&!this.isDisabled&&(this.image=k.extend({},this.initialImage),this.canvas=k.extend({},this.initialCanvas),this.cropBox=k.extend({},this.initialCropBox),this.renderCanvas(),this.isCropped&&this.renderCropBox())},clear:function(){this.isCropped&&!this.isDisabled&&(k.extend(this.cropBox,{left:0,top:0,width:0,height:0}),this.isCropped=!1,this.renderCropBox(),this.limitCanvas(!0,!0),this.renderCanvas(),this.$dragBox.removeClass(l),this.$cropBox.addClass(x))},replace:function(t,i){!this.isDisabled&&t&&(this.isImg&&this.$element.attr("src",t),i?(this.url=t,this.$clone.attr("src",t),this.isBuilt&&this.$preview.find("img").add(this.$clone2).attr("src",t)):(this.isImg&&(this.isReplaced=!0),this.options.data=null,this.load(t)))},enable:function(){this.isBuilt&&(this.isDisabled=!1,this.$cropper.removeClass(i))},disable:function(){this.isBuilt&&(this.isDisabled=!0,this.$cropper.addClass(i))},destroy:function(){var t=this.$element;this.isLoaded?(this.isImg&&this.isReplaced&&t.attr("src",this.originalUrl),this.unbuild(),t.removeClass(x)):this.isImg?t.off(_,this.start):this.$clone&&this.$clone.remove(),t.removeData(p)},move:function(t,i){var e=this.canvas;this.moveTo(ot(t)?t:e.left+V(t),ot(i)?i:e.top+V(i))},moveTo:function(t,i){var e=this.canvas,s=!1;ot(i)&&(i=t),t=V(t),i=V(i),this.isBuilt&&!this.isDisabled&&this.options.movable&&(at(t)&&(e.left=t,s=!0),at(i)&&(e.top=i,s=!0),s&&this.renderCanvas(!0))},zoom:function(t,i){var e=this.canvas;t=(t=V(t))<0?1/(1-t):1+t,this.zoomTo(e.width*t/e.naturalWidth,i)},zoomTo:function(t,i){var e,s,a,o,n=this.options,h=this.canvas,r=h.width,p=h.height,l=h.naturalWidth,c=h.naturalHeight;0<=(t=V(t))&&this.isBuilt&&!this.isDisabled&&n.zoomable&&(e=l*t,n=c*t,i&&(s=i.originalEvent),this.trigger(Y,{originalEvent:s,oldRatio:r/l,ratio:e/l}).isDefaultPrevented()||(s?(c=this.$cropper.offset(),s=s.touches?(t=s.touches,l=t.length,o=a=0,l&&(k.each(t,function(t,i){a+=i.pageX,o+=i.pageY}),a/=l,o/=l),{pageX:a,pageY:o}):{pageX:i.pageX||s.pageX||0,pageY:i.pageY||s.pageY||0},h.left-=(e-r)*((s.pageX-c.left-h.left)/r),h.top-=(n-p)*((s.pageY-c.top-h.top)/p)):(h.left-=(e-r)/2,h.top-=(n-p)/2),h.width=e,h.height=n,this.renderCanvas(!0)))},rotate:function(t){this.rotateTo((this.image.rotate||0)+V(t))},rotateTo:function(t){at(t=V(t))&&this.isBuilt&&!this.isDisabled&&this.options.rotatable&&(this.image.rotate=t%360,this.isRotated=!0,this.renderCanvas(!0))},scale:function(t,i){var e=this.image,s=!1;ot(i)&&(i=t),t=V(t),i=V(i),this.isBuilt&&!this.isDisabled&&this.options.scalable&&(at(t)&&(e.scaleX=t,s=!0),at(i)&&(e.scaleY=i,s=!0),s&&this.renderImage(!0))},scaleX:function(t){var i=this.image.scaleY;this.scale(t,at(i)?i:1)},scaleY:function(t){var i=this.image.scaleX;this.scale(at(i)?i:1,t)},getData:function(e){var s,a,t=this.options,i=this.image,o=this.canvas,n=this.cropBox;return this.isBuilt&&this.isCropped?(a={x:n.left-o.left,y:n.top-o.top,width:n.width,height:n.height},s=i.width/i.naturalWidth,k.each(a,function(t,i){i/=s,a[t]=e?it(i):i})):a={x:0,y:0,width:0,height:0},t.rotatable&&(a.rotate=i.rotate||0),t.scalable&&(a.scaleX=i.scaleX||1,a.scaleY=i.scaleY||1),a},setData:function(t){var i,e,s=this.options,a=this.image,o=this.canvas,n={};k.isFunction(t)&&(t=t.call(this.element)),this.isBuilt&&!this.isDisabled&&k.isPlainObject(t)&&(s.rotatable&&at(t.rotate)&&t.rotate!==a.rotate&&(a.rotate=t.rotate,this.isRotated=i=!0),s.scalable&&(at(t.scaleX)&&t.scaleX!==a.scaleX&&(a.scaleX=t.scaleX,e=!0),at(t.scaleY)&&t.scaleY!==a.scaleY&&(a.scaleY=t.scaleY,e=!0)),i?this.renderCanvas():e&&this.renderImage(),a=a.width/a.naturalWidth,at(t.x)&&(n.left=t.x*a+o.left),at(t.y)&&(n.top=t.y*a+o.top),at(t.width)&&(n.width=t.width*a),at(t.height)&&(n.height=t.height*a),this.setCropBoxData(n))},getContainerData:function(){return this.isBuilt?this.container:{}},getImageData:function(){return this.isLoaded?this.image:{}},getCanvasData:function(){var e=this.canvas,s={};return this.isBuilt&&k.each(["left","top","width","height","naturalWidth","naturalHeight"],function(t,i){s[i]=e[i]}),s},setCanvasData:function(t){var i=this.canvas,e=i.aspectRatio;k.isFunction(t)&&(t=t.call(this.$element)),this.isBuilt&&!this.isDisabled&&k.isPlainObject(t)&&(at(t.left)&&(i.left=t.left),at(t.top)&&(i.top=t.top),at(t.width)?(i.width=t.width,i.height=t.width/e):at(t.height)&&(i.height=t.height,i.width=t.height*e),this.renderCanvas(!0))},getCropBoxData:function(){var t,i=this.cropBox;return(t=this.isBuilt&&this.isCropped?{left:i.left,top:i.top,width:i.width,height:i.height}:t)||{}},setCropBoxData:function(t){var i,e,s=this.cropBox,a=this.options.aspectRatio;k.isFunction(t)&&(t=t.call(this.$element)),this.isBuilt&&this.isCropped&&!this.isDisabled&&k.isPlainObject(t)&&(at(t.left)&&(s.left=t.left),at(t.top)&&(s.top=t.top),at(t.width)&&(i=!0,s.width=t.width),at(t.height)&&(e=!0,s.height=t.height),a&&(i?s.height=s.width/a:e&&(s.width=s.height*a)),this.renderCropBox())},getCroppedCanvas:function(t){var y,B,i,D,e,s,a,T;if(this.isBuilt&&this.isCropped&&N)return k.isPlainObject(t)||(t={}),T=this.getData(),y=T.width,B=T.height,e=y/B,k.isPlainObject(t)&&(s=t.width,a=t.height,s?(a=s/e,D=s/y):a&&(s=a*e,D=a/B)),i=et(s||y),e=et(a||B),(s=k("<canvas>")[0]).width=i,s.height=e,a=s.getContext("2d"),t.fillColor&&(a.fillStyle=t.fillColor,a.fillRect(0,0,i,e)),a.drawImage.apply(a,function(){var t,i,e,s,a,o,n,h,r,p,l,c,d,g,u,f,m,v,w,b=(t=this.$clone[0],i=this.image,$=k("<canvas>")[0],C=$.getContext("2d"),o=a=0,b=i.naturalWidth,x=i.naturalHeight,n=i.rotate,h=i.scaleX,r=i.scaleY,p=at(h)&&at(r)&&(1!==h||1!==r),l=at(n)&&0!==n,_=l||p,c=b*Q(h||1),d=x*Q(r||1),p&&(e=c/2,s=d/2),l&&(e=(c=(i=lt({width:c,height:d,degree:n})).width)/2,s=(d=i.height)/2),$.width=c,$.height=d,_&&(a=-b/2,o=-x/2,C.save(),C.translate(e,s)),l&&C.rotate(n*Math.PI/180),p&&C.scale(h,r),C.drawImage(t,et(a),et(o),et(b),et(x)),_&&C.restore(),$),x=b.width,_=b.height,C=this.canvas,$=[b],b=T.x+C.naturalWidth*(Q(T.scaleX||1)-1)/2,C=T.y+C.naturalHeight*(Q(T.scaleY||1)-1)/2;return b<=-y||x<b?b=g=f=v=0:b<=0?(f=-b,g=v=K(x,y+(b=0))):b<=x&&(f=0,g=v=K(y,x-b)),g<=0||C<=-B||_<C?C=u=m=w=0:C<=0?(m=-C,u=w=K(_,B+(C=0))):C<=_&&(m=0,u=w=K(B,_-C)),$.push(et(b),et(C),et(g),et(u)),D&&(f*=D,m*=D,v*=D,w*=D),0<v&&0<w&&$.push(et(f),et(m),et(v),et(w)),$}.call(this)),s},setAspectRatio:function(t){var i=this.options;this.isDisabled||ot(t)||(i.aspectRatio=Z(0,t)||NaN,this.isBuilt&&(this.initCropBox(),this.isCropped&&this.renderCropBox()))},setDragMode:function(t){var i,e,s=this.options;this.isLoaded&&!this.isDisabled&&(i=t===S,e=s.movable&&t===j,t=i||e?t:"none",this.$dragBox.data(H,t).toggleClass(u,i).toggleClass(g,e),s.cropBoxMovable||this.$face.data(H,t).toggleClass(u,i).toggleClass(g,e))}},dt.DEFAULTS={viewMode:0,dragMode:"crop",aspectRatio:NaN,data:null,preview:"",responsive:!0,restore:!0,checkCrossOrigin:!0,checkOrientation:!0,modal:!0,guides:!0,center:!0,highlight:!0,background:!0,autoCrop:!0,autoCropArea:.8,movable:!0,rotatable:!0,scalable:!0,zoomable:!0,zoomOnTouch:!0,zoomOnWheel:!0,wheelZoomRatio:.1,cropBoxMovable:!0,cropBoxResizable:!0,toggleDragModeOnDblclick:!0,minCanvasWidth:0,minCanvasHeight:0,minCropBoxWidth:0,minCropBoxHeight:0,minContainerWidth:200,minContainerHeight:100,build:null,built:null,cropstart:null,cropmove:null,cropend:null,crop:null,zoom:null},dt.setDefaults=function(t){k.extend(dt.DEFAULTS,t)},dt.TEMPLATE='<div class="cropper-container"><div class="cropper-wrap-box"><div class="cropper-canvas"></div></div><div class="cropper-drag-box"></div><div class="cropper-crop-box"><span class="cropper-view-box"></span><span class="cropper-dashed dashed-h"></span><span class="cropper-dashed dashed-v"></span><span class="cropper-center"></span><span class="cropper-face"></span><span class="cropper-line line-e" data-action="e"></span><span class="cropper-line line-n" data-action="n"></span><span class="cropper-line line-w" data-action="w"></span><span class="cropper-line line-s" data-action="s"></span><span class="cropper-point point-e" data-action="e"></span><span class="cropper-point point-n" data-action="n"></span><span class="cropper-point point-w" data-action="w"></span><span class="cropper-point point-s" data-action="s"></span><span class="cropper-point point-ne" data-action="ne"></span><span class="cropper-point point-nw" data-action="nw"></span><span class="cropper-point point-sw" data-action="sw"></span><span class="cropper-point point-se" data-action="se"></span></div></div>',dt.other=k.fn.cropper,k.fn.cropper=function(a){var o,n=nt(arguments,1);return this.each(function(){var t,i,e=k(this),s=e.data(p);if(!s){if(/destroy/.test(a))return;t=k.extend({},e.data(),k.isPlainObject(a)&&a),e.data(p,s=new dt(this,t))}"string"==typeof a&&k.isFunction(i=s[a])&&(o=i.apply(s,n))}),ot(o)?this:o},k.fn.cropper.Constructor=dt,k.fn.cropper.setDefaults=dt.setDefaults,k.fn.cropper.noConflict=function(){return k.fn.cropper=dt.other,this}}),define("plone_app_imagecropping_cropperpattern",["pat-base","jquery","plone_app_imagecropping_cropper"],function(t,a){"use strict";return t.extend({name:"image-cropper",trigger:".pat-image-cropper",parser:"mockup",while_reset:!1,while_init:!0,while_saving:!1,_changed:!1,defaults:{identifier:null,fieldname:null,saveurl:null,authenticator:null,scale:null,preview:null,is_cropped:null,view_mode:3,aspect_ratio:16/9,currrent_x:null,currrent_y:null,currrent_w:null,currrent_h:null,true_width:null,true_height:null},update_badges:function(){if(this.while_saving)return this.$badge_saving.show(),this.$button_save.prop("disabled",!0),this.$button_reset.prop("disabled",!0),void this.$button_remove.prop("disabled",!0);this.$badge_saving.hide(),this.options.is_cropped?(this.$button_remove.prop("disabled",!1),this.$badge_uncropped.hide(),this.$badge_cropped.show()):(this.$button_remove.prop("disabled",!0),this.$badge_uncropped.show(),this.$badge_cropped.hide()),this.crop_changed()?(this.$badge_changed.show(),this.$button_save.prop("disabled",!1),this.$button_reset.prop("disabled",!1)):(this.$badge_changed.hide(),this.options.is_cropped?this.$button_save.prop("disabled",!0):this.$button_save.prop("disabled",!1),this.$button_reset.prop("disabled",!0))},crop_changed:function(){if(this.while_init||this.while_reset)return!1;if(!a(".cropper-container",this.$image.parent()).is(":visible"))return this._changed;var t=this.$image.cropper("getData"),i=this.original_data.x-1<t.x&&t.x<this.original_data.x+1,e=this.original_data.y-1<t.y&&t.y<this.original_data.y+1,s=this.original_data.width-1<t.width&&t.width<this.original_data.width+1,t=this.original_data.height-1<t.height&&t.height<this.original_data.height+1;return this._changed=!(i&&e&&s&&t),this._changed},reset:function(){console.log("RESET"),this.while_reset=!0,this.cropper.setData(this.original_data),this.visualize_selected_area(),this.while_reset=!1,this.update_badges()},remove:function(){console.log("REMOVE");var s=this,t={remove:!0,fieldname:this.options.fieldname,scale:this.options.scalename,_authenticator:this.options.authenticator};s.while_saving=!0,s.update_badges(),a.ajax({url:this.options.saveurl,type:"POST",data:t,success:function(t,i,e){s.options.is_cropped=!1,s.while_saving=!1,s.update_badges()},error:function(t,i,e){s.while_saving=!1,s.update_badges(),alert(i,e)}})},save:function(){console.log("SAVE "+this.identifier);var s=this,t=this.$image.cropper("getData"),t={x:t.x,y:t.y,width:t.width,height:t.height,fieldname:this.options.fieldname,scale:this.options.scalename,_authenticator:this.options.authenticator};s.while_saving=!0,s.update_badges(),a.ajax({url:this.options.saveurl,type:"POST",data:t,success:function(t,i,e){s.options.is_cropped=!0,s._changed=!1,s.original_data=a.extend({},s.cropper.getData()),s.while_saving=!1,s.update_badges()},error:function(t,i,e){s.while_saving=!1,s.update_badges(),alert(i,e)}})},visualize_selected_area:function(){var t=this.$image.cropper("getData");a(".cropx",self.$el).text(Math.round(t.x)),a(".cropy",self.$el).text(Math.round(t.y)),a(".cropw",self.$el).text(Math.round(t.width)),a(".croph",self.$el).text(Math.round(t.height))},notify_visible:function(){this.while_reset=!0,this.cropper.resize(),this.options.is_cropped&&!this.crop_changed()&&(console.log("set to orig"),this.cropper.setData(this.original_data),this.visualize_selected_area()),this.while_reset=!1},limit_minimum_cropping_size:function(){var t=this.$image.cropper("getData"),i={};(t.width<this.options.target_width||t.height<this.options.target_height)&&(i.width=this.options.target_width,i.height=this.options.target_height,t.x+this.options.target_width>this.options.true_width?i.x=this.options.true_width-this.options.target_width:i.x=t.x,t.y+this.options.target_height>this.options.true_height?i.y=this.options.true_height-this.options.target_height:i.y=t.y,i.rotate=t.rotate,i.scaleX=t.scaleX,i.scaleY=t.scaleY,this.while_reset=!0,this.cropper.setData(i),this.while_reset=!1)},init:function(){var i=this,t=(i.$el.parent().hasClass("d-none"),"#select-"+i.options.identifier),e=(i.options.identifier,"#croppingarea-"+i.options.identifier);i.identifier=i.options.identifier,i.$image=a("img.main-image",i.$el),i.$badge_cropped=a(t+" .badge.cropped"),i.$badge_uncropped=a(t+" .badge.uncropped"),i.$badge_changed=a(t+" .badge.changed"),i.$badge_saving=a(t+" .badge.saving"),i.$button_save=a(e+" button.save"),i.$button_remove=a(e+" button.remove"),i.$button_reset=a(e+" button.reset"),i.$button_save_all=a("button.save-all"),i.options.current_x=parseFloat(i.options.current_x),i.options.current_y=parseFloat(i.options.current_y),i.options.current_w=parseFloat(i.options.current_w),i.options.current_h=parseFloat(i.options.current_h),i.options.true_width=parseFloat(i.options.true_width),i.options.true_height=parseFloat(i.options.true_height),i.options.target_width=parseFloat(i.options.target_width),i.options.target_height=parseFloat(i.options.target_height),i.options.is_cropped="True"==i.options.is_cropped,i.original_data={x:this.options.current_x,y:this.options.current_y,width:this.options.current_w,height:this.options.current_h,rotate:0,scaleX:1,scaleY:1},i.update_badges(),i.$button_reset.click(function(){i.reset()}),i.$button_remove.click(function(){i.remove()}),i.$button_save.click(function(){i.save()}),i.$button_save_all.on("click",{identifier:i.identifier},function(t){i.crop_changed()&&i.save()});e={preview:i.options.preview,data:i.original_data,autoCrop:!0,autoCropArea:1,aspectRatio:parseFloat(i.options.aspect_ratio),viewMode:i.options.view_mode,restore:!1,crop:function(t){i.while_init||i.while_reset||(i.limit_minimum_cropping_size(),i.update_badges(),i.visualize_selected_area())},built:function(){i.reset(),i.while_init=!1}};i.$image.cropper(e),i.cropper=i.$image.data("cropper"),i.$image.on("CROPPERPATTERN.VISIBLE",function(){i.notify_visible()})}})}),define("plone_app_imagecropping_cropscaleselect",["pat-base","jquery"],function(t,n){"use strict";return t.extend({name:"imagecropsave",trigger:".pat-imagecrop-scaleselect",parser:"mockup",trigger_notify_visible:function(t){console.log("Trigger event");var i=n.Event("CROPPERPATTERN.VISIBLE");t.trigger(i)},toggle_li:function(t){var i=n(t),t=n(i.parent());i.hasClass("active")||(n("li.list-group-item.active",t).removeClass("active").addClass("inactive"),i.removeClass("inactive").addClass("active"),t=n(n(i.data("cropping-area"))),i=n(t.parent()),n(".singlecroppingarea.d-block",i).removeClass("d-block").addClass("d-none"),t.removeClass("d-none").addClass("d-block"),t=n("img.main-image",t),this.trigger_notify_visible(t))},set_preview_dimensions:function(t){var i=n(t),e=n(".preview-container",i),s=n(".crop-preview",e),a=parseFloat(e.data("target-width")),o=parseFloat(e.data("target-height")),t=i.width(),i=null,i=a<=t?o:o*t/a;e.width(t),e.height(i),s.width(t),s.height(i)},init:function(){var e=this;document.querySelector('a[data-bs-toggle="tab"]').addEventListener("shown.bs.tab",function(t){var i=n("div.singlecroppingarea.active img.main-image",$fieldset);this.trigger_notify_visible(i)}),n(".tab-pane",e.$el).each(function(t){n("li.list-group-item.scalable",n(this)).each(function(t){var i=this;e.set_preview_dimensions(i),n(i).click(function(){e.toggle_li(i)})})})}})}),require(["plone_app_imagecropping_cropperpattern","plone_app_imagecropping_cropscaleselect"],function(){}),define("/Volumes/WORKSPACE2/kinderdorf_plone5/srcaddons/plone.app.imagecropping/src/plone/app/imagecropping/browser/static/bundle.js",function(){});
//# sourceMappingURL=imagecropping-compiled.js.map